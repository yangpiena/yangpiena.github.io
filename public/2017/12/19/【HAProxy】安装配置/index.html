<!DOCTYPE html>
<html>
  <!-- Html Head Tag-->
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="昜丿捺">
  <!-- Open Graph Data -->
  <meta property="og:title" content="【HAProxy】安装配置"/>
  <meta property="og:description" content="没有阳光，沉默而居" />
  <meta property="og:site_name" content="昜丿捺"/>
  <meta property="og:type" content="article" />
  <meta property="og:image" content="http://yoursite.comundefined"/>
  
    <link rel="alternate" href="/atom.xml" title="昜丿捺" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  

  <!-- Site Title -->
  <title>昜丿捺</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <!-- Custom CSS -->
  <!-- YPN Edit 2016-11-11 增加根据时间自动切换主题风格 -->
  <!-- 
       <link rel="stylesheet" href="/css/style.light.css"> -->
  
  
  <link rel="stylesheet" href="/css/style.light.css">

  <script type="text/javascript" src="/js/jquery-1.11.3.min.js"></script>
</head>

  <body>
    <!-- Page Header -->


<header class="site-header header-background" style="background-image: url(http://ogoh2gimk.bkt.clouddn.com/yangpiena-banner.jpg)">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-title with-background-image">
          <p class="title">【HAProxy】安装配置</p>
          <p class="subtitle"></p>
        </div>
        <div class="site-menu with-background-image">
          <ul>
            
              <li>
                <a href="/">
                  
                  主页
                  
                </a>
              </li>
            
              <li>
                <a href="/archives">
                  
                  归类
                  
                </a>
              </li>
            
              <li>
                <a href="/tags">
                  
                  标签
                  
                </a>
              </li>
            
              <li>
                <a href="/links">
                  
                  链接
                  
                </a>
              </li>
            
              <li>
                <a href="/photos">
                  
                  相册
                  
                </a>
              </li>
            
              <li>
                <a href="/about">
                  
                  关于
                  
                </a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
<!-- YPN Del 2016-12-27 因swiftype不能免费使用了，固已注销账号，停止使用搜索功能。
  
    <form class="search" action="/search/index.html" method="get" accept-charset="utf-8" style="text-align:right">
    <label>Search</label>
    <input type="text" id="search" class="st-default-search-input" maxlength="20" placeholder="Search" />
    </form>
  
-->
</header>

<article>
  <div class="container typo">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-info text-muted">
          
            <!-- Author -->
            <span class="author info">作者 昜丿捺</span>
          
          <!-- Date -->
          <span class="date-time info">发表于
            <span class="date">2017-12-19</span>
            <span class="time">11:03:56</span>
          </span>
          
          <!--  Categories  -->
            <span class="categories info">分类于 

<a href="/categories/HAProxy/">HAProxy</a>
</span>
          

          <!-- YPN Add 2016-11-14 增加热度 -->
          <span id="busuanzi_container_page_pv">
            &nbsp;&nbsp; 热度&nbsp; <span id="busuanzi_value_page_pv"></span>°C
          </span>

        </div>
        <!-- Tags -->
        
          <div class="post-tags text-muted">
            标签: 

<a class="tag" href="/tags/HAProxy/">#HAProxy</a>


          </div>
        
        <!-- Post Main Content -->
        <div class="post-content">

			<!-- YPN Add 2017-02-27 Table of Contents -->
			
			
          	<h3 id="HAProxy简介"><a href="#HAProxy简介" class="headerlink" title="HAProxy简介"></a>HAProxy简介</h3><p>HAProxy是一个使用C语言编写的自由及开放源代码软件，其提供高可用性、负载均衡，以及基于TCP和HTTP的应用程序代理。<br>HAProxy特别适用于那些负载特大的web站点，这些站点通常又需要会话保持或七层处理。HAProxy运行在当前的硬件上，完全可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单安全的整合进您当前的架构中， 同时可以保护你的web服务器不被暴露到网络上。<br>HAProxy实现了一种事件驱动, 单一进程模型，此模型支持非常大的并发连接数。多进程或多线程模型受内存限制 、系统调度器限制以及无处不在的锁限制，很少能处理数千并发连接。事件驱动模型因为在有更好的资源和时间管理的用户空间(User-Space) 实现所有这些任务，所以没有这些问题。此模型的弊端是，在多核系统上，这些程序通常扩展性较差。这就是为什么他们必须进行优化以 使每个CPU时间片(Cycle)做更多的工作。<br>包括 GitHub、Bitbucket、Stack Overflow、Reddit、Tumblr、Twitter和 Tuenti在内的知名网站，及亚马逊网络服务系统都使用了HAProxy。</p>
<a id="more"></a>
<hr>
<h3 id="HAProxy下载"><a href="#HAProxy下载" class="headerlink" title="HAProxy下载"></a>HAProxy下载</h3><p><a href="https://www.haproxy.org/" target="_blank" rel="external">官网下载</a><br><a href="https://fossies.org/linux/misc/" target="_blank" rel="external">Fossies下载</a></p>
<hr>
<h3 id="HAProxy安装"><a href="#HAProxy安装" class="headerlink" title="HAProxy安装"></a>HAProxy安装</h3><h4 id="1-Linux下"><a href="#1-Linux下" class="headerlink" title="1. Linux下"></a>1. Linux下</h4><h5 id="1-1-下载"><a href="#1-1-下载" class="headerlink" title="1.1 下载"></a>1.1 下载</h5><p>进入下载目录，使用wget下载，如果已离线下载成功，则跳过该步，直接上传安装包到下载目录即可<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd /usr/download/</div><div class="line">wget http://fossies.org/linux/misc/haproxy-1.8.1.tar.gz</div></pre></td></tr></table></figure></p>
<h5 id="1-2-解压"><a href="#1-2-解压" class="headerlink" title="1.2 解压"></a>1.2 解压</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tar -zxvf haproxy-1.8.1.tar.gz</div></pre></td></tr></table></figure>
<h5 id="1-3-安装"><a href="#1-3-安装" class="headerlink" title="1.3 安装"></a>1.3 安装</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cd haproxy-1.8.1</div><div class="line">make TARGET=linux2628 ARCH=x86_64 PREFIX=/usr/local/haproxy</div><div class="line">make install PREFIX=/usr/local/haproxy</div></pre></td></tr></table></figure>
<p>参数说明:<br><strong>TARGET=linux2628</strong>          #内核版本，使用<code>uname -r</code>可查看内核，如：2.6.32-642.11.1.el6.x86_64，此时该参数就为linux2628；kernel 小于2.6.28的用：TARGET=linux26<br><strong>ARCH=x86_64</strong>               #系统位数<br><strong>PREFIX=/usr/local/haprpxy</strong> #/usr/local/haprpxy为haprpxy的安装路径</p>
<blockquote>
<p>CentOS中无法使用make、make install命令，提示：make: command not found，此时需在线安装make和gcc。</p>
<ul>
<li>安装make<br>yum -y install gcc automake autoconf libtool make</li>
<li>安装gcc<br>yum install gcc gcc-c++</li>
</ul>
</blockquote>
<h4 id="2-Windows下"><a href="#2-Windows下" class="headerlink" title="2. Windows下"></a>2. Windows下</h4><p><em>暂无</em></p>
<hr>
<h3 id="HAProxy配置"><a href="#HAProxy配置" class="headerlink" title="HAProxy配置"></a>HAProxy配置</h3><p>安装完毕后，进入安装目录修改配置文件，默认情况下安装目录里是没有.cfg配置文件的，可以回到安装文件目录下，将examples下的haproxy.cfg拷贝到usr/local/haproxy下。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi /usr/local/haproxy/haproxy.cfg</div></pre></td></tr></table></figure></p>
<p>粘贴如下内容至haproxy.cfg</p>
<pre><code>###################### 全局配置 ######################
global
      log            127.0.0.1 local0                       # 日志输出配置，所有日志都记录在本机，通过local0输出
    # log            127.0.0.1 local1 notice                # 定义haproxy 日志级别[error warring info debug]
    # log            loghost local0 info
      maxconn        1500                                   # 默认最大连接数,需考虑ulimit-n限制
      chroot         /usr/local/haproxy                     # 改变当前工作目录
      uid            haproxy                                # 运行haproxy的用户
      gid            haproxy                                # 运行haproxy的用户所在的组
      daemon                                                # 以后台形式运行harpoxy
    # nbproc         2                                      # 设置进程数量
      pidfile        /usr/local/haproxy/logs/haproxy.pid    #将所有进程的pid写入文件，启动进程的用户必须有权限访问此文件
    # debug                                                 # haproxy 调试级别，建议只在开启单进程的时候调试
    # quiet

###################### 默认配置 ######################
defaults
        log             global
        mode            http              # 默认的模式mode { tcp|http|health }，tcp是4层，http是7层，health只会返回OK
        option          httpclose         # 每次请求完毕后主动关闭http通道,haproxy不支持keep-alive,只能模拟这种模式的实现
      # option          dontlognull       # 不记录健康检查日志信息
        option          forwardfor        # 如果后端服务器需要获得客户端真实ip需要配置的参数，可以从Http Header中获得客户端ip
        option          redispatch        # 当serverId对应的服务器挂掉后，强制定向到其他健康的服务器，以后将不支持
      # option          abortonclose      # 当服务器负载很高的时候，自动结束掉当前队列处理比较久的链接
        retries         2                 # 两次连接失败就认为是服务器不可用，也可以通过后面设置
        balance         static-rr         # 支持static-rr，leastconn,first,uri等参数
      # balance         roundrobin        # 设置默认负载均衡方式，轮询方式
      # balance         source            # 设置默认负载均衡方式，保存session值，类似于nginx的ip_hash
      # balnace         leastconn         # 设置默认负载均衡方式，最小连接数
        stats           enable
      # stats uri       /ha?stats         # haproxy运行状态查看 自定义uri
        stats uri       /haproxy-stats    # haproxy运行状态查看 自定义uri
        stats refresh   30s               # 统计页面自动刷新时间
        timeout connect 3000              # 连接超时
        timeout client  50000             # 客户端超时
        timeout server  50000             # 服务器超时
      # timeout check   2000              # 心跳检测超时
      # timeout http-keep-alive 10s       # 默认持久连接超时时间
      # timeout http-request    10s       # 默认http请求超时时间
      # timeout queue   1m                # 默认队列超时时间

###################### 统计页面配置 ######################
listen stats
       bind          0.0.0.0:1080         # 设置Frontend和Backend的组合体，监控组的名称，按需要自定义名称
       mode          http                 # http的7层模式
       option        httplog              # 采用http日志格式
     # log           127.0.0.1 local0 err # 错误日志记录
       maxconn       10                   # 默认的最大连接数
       stats refresh 30s                  # 统计页面自动刷新时间
       stats uri     /stats               # 统计页面url
       stats realm   YANGPIENA\ Haproxy   # 统计页面密码框上提示文本
       stats auth    admin:admin          # 设置监控页面的用户和密码:admin,可以设置多个用户名
       stats auth    Frank:Frank          # 设置监控页面的用户和密码：Frank
       stats hide-version                 # 隐藏统计页面上HAProxy的版本信息
       stats admin if TRUE                # 设置手工启动/禁用，后端服务器(haproxy-1.4.9以后版本)

###################### 业务配置 ######################
listen xx              0.0.0.0:80
       balance         source                                 # 使用JSESSIONID时，此负载均衡方式必须为source 
     # cookie SERVERID insert                                 # 允许插入serverid到cookie中，serverid后面可以定义
     # option httpchk GET /root/index.jsp HTTP/1.0            # 健康检测 检测server web根目录有无此文件
       appsession JSESSIONID len 64 timeout 5h request-learn
       server  10.1.50.41:80 10.1.50.41:80 weight 3 check
       server  10.1.50.42:80 10.1.50.42:80 weight 3 check

     # 此类方法，即使用cookie模式时，balance需设为roundrobin，且需要cookie SERVERID insert
     # server server_151 86.2.1.151:80 cookie server_151 check
     # server server_152 86.2.1.152:80 cookie server_152 check

     # server server_151 86.2.1.151:80 cookie server_151 check inter 1500 rise 3 fall 3 weight 1
     # 服务器定义，cookie 1表示serverid为web1，check inter 1500是检测心跳频率rise 3是3次正确认为服务器可用，fall 3是3次失败认为服务器不可用，weight代表权重
     # server server_152 86.2.1.152:80 cookie server_152 check inter 1500 rise 3 fall 3 weight 2
     # 服务器定义，cookie 1表示serverid为web2，check inter 1500是检测心跳频率rise 3是3次正确认为服务器可用， fall 3是3次失败认为服务器不可用，weight代表权重


# # 原资料
# ###################### 设置haproxy 错误页面 ######################
# #errorfile 403 /home/haproxy/haproxy/errorfiles/403.http
# #errorfile 500 /home/haproxy/haproxy/errorfiles/500.http
# #errorfile 502 /home/haproxy/haproxy/errorfiles/502.http
# #errorfile 503 /home/haproxy/haproxy/errorfiles/503.http
# #errorfile 504 /home/haproxy/haproxy/errorfiles/504.http
# 
# ###################### frontend前端配置 ######################
# frontend main
# 　　bind *:80 #这里建议使用bind *:80的方式，要不然做集群高可用的时候有问题，vip切换到其他机器就不能访问了。
# 　　acl web hdr(host) -i www.abc.com  #acl后面是规则名称，-i为忽略大小写，后面跟的是要访问的域名，如果访问www.abc.com这个域名，就触发web规则，。
# 　　acl img hdr(host) -i img.abc.com  #如果访问img.abc.com这个域名，就触发img规则。
# 　　use_backend webserver if web   #如果上面定义的web规则被触发，即访问www.abc.com，就将请求分发到webserver这个作用域。
# 　　use_backend imgserver if img   #如果上面定义的img规则被触发，即访问img.abc.com，就将请求分发到imgserver这个作用域。
# 　　default_backend dynamic #不满足则响应backend的默认页面
# 
# ###################### backend后端配置 ######################
# backend webserver #webserver作用域
# 　　mode http
# 　　balance roundrobin #balance roundrobin 负载轮询，balance source 保存session值，支持static-rr，leastconn，first，uri等参数
# 　　option httpchk /index.html HTTP/1.0 #健康检查, 检测文件，如果分发到后台index.html访问不到就不再分发给它
# 　　server web1 10.16.0.9:8085 cookie 1 weight 5 check inter 2000 rise 2 fall 3
# 　　server web2 10.16.0.10:8085 cookie 2 weight 3 check inter 2000 rise 2 fall 3
# 　　#cookie 1表示serverid为1，check inter 1500 是检测心跳频率 
# 　　#rise 2是2次正确认为服务器可用，fall 3是3次失败认为服务器不可用，weight代表权重
# 
# backend imgserver
# 　　mode http
# 　　option httpchk /index.php
# 　　balance roundrobin 
# 　　server img01 192.168.137.101:80 check inter 2000 fall 3
# 　　server img02 192.168.137.102:80 check inter 2000 fall 3
# 
# backend dynamic 
# 　　balance roundrobin 
# 　　server test1 192.168.1.23:80 check maxconn 2000 
# 　　server test2 192.168.1.24:80 check maxconn 2000
# 
# listen tcptest 
# 　　bind 0.0.0.0:5222 
# 　　mode tcp 
# 　　option tcplog #采用tcp日志格式 
# 　　balance source 
# 　　#log 127.0.0.1 local0 debug 
# 　　server s1 192.168.100.204:7222 weight 1 
# 　　server s2 192.168.100.208:7222 weight 1
</code></pre><hr>
<h3 id="HAProxy启动"><a href="#HAProxy启动" class="headerlink" title="HAProxy启动"></a>HAProxy启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/local/haproxy/sbin/haproxy -f /usr/local/haproxy/haproxy.cfg</div></pre></td></tr></table></figure>
<p>检查是否启动：</p>
<pre><code>[root@Linux-xx ~]# ps -e|grep haproxy
 1221 ?        00:01:32 haproxy
</code></pre><p>看到上面结果，表明haproxy已经正常启动了。</p>
<hr>
<h3 id="HAProxy查看状态"><a href="#HAProxy查看状态" class="headerlink" title="HAProxy查看状态"></a>HAProxy查看状态</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://localhost:1080/stats</div></pre></td></tr></table></figure>
<p>参数说明：<br><strong>1080</strong>  即haproxy配置文件中的监听端口<br><strong>stats</strong> 即haproxy配置文件中的监听名称</p>
<p>如果无法访问，请查看防火墙中端口是否开启。</p>
<blockquote>
<p>Centos查看80端口占用情况，使用命令：<code>lsof -i tcp:80</code><br>Centos列出所有使用的端口，使用命令：<code>netstat -ntlp</code></p>
</blockquote>
<p>如果端口未开启，请设置防火墙开放端口。</p>
<h4 id="1-开启端口（以80端口为例）"><a href="#1-开启端口（以80端口为例）" class="headerlink" title="1. 开启端口（以80端口为例）"></a>1. 开启端口（以80端口为例）</h4><ul>
<li><p>方法一：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/sbin/iptables -I INPUT -p tcp --dport 80 -j ACCEPT   ## 写入修改 </div><div class="line">/etc/init.d/iptables save                             ## 保存修改 </div><div class="line">service iptables restart                              ## 重启防火墙，使修改生效</div></pre></td></tr></table></figure>
</li>
<li><p>方法二：<br>  先打开配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi /etc/sysconfig/iptables</div></pre></td></tr></table></figure>
<p>  再加入下面内容</p>
<pre><code>-A INPUT -p tcp -m state --state NEW -m tcp --dport 80 -j ACCEPT
</code></pre><p>  最后，重启防火墙或重启计算机，修改完成。</p>
<blockquote>
<p>修改防火墙时注意最好留下VNC和SSH的管理端口。</p>
</blockquote>
</li>
</ul>
<h4 id="2-关闭端口"><a href="#2-关闭端口" class="headerlink" title="2. 关闭端口"></a>2. 关闭端口</h4><ul>
<li><p>方法一：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/sbin/iptables -I INPUT -p tcp --dport 80 -j DROP   ## 写入修改 </div><div class="line">/etc/init.d/iptables save                           ## 保存修改 </div><div class="line">service iptables restart                            ## 重启防火墙，使修改生效</div></pre></td></tr></table></figure>
</li>
<li><p>方法二：<br>  先打开配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi /etc/sysconfig/iptables</div></pre></td></tr></table></figure>
<p>  再加入下面内容</p>
<pre><code>-A INPUT -p tcp -m state --state NEW -m tcp --dport 80 -j DROP
</code></pre><p>  最后重启防火墙或重启计算机，修改完成。</p>
</li>
</ul>
<h4 id="3-查看端口状态"><a href="#3-查看端口状态" class="headerlink" title="3. 查看端口状态"></a>3. 查看端口状态</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/etc/init.d/iptables status</div></pre></td></tr></table></figure>
<h4 id="4-临时性完全关闭防火墙，可以不重启计算机"><a href="#4-临时性完全关闭防火墙，可以不重启计算机" class="headerlink" title="4. 临时性完全关闭防火墙，可以不重启计算机"></a>4. 临时性完全关闭防火墙，可以不重启计算机</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#/etc/init.d/iptables status                ## 查看防火墙状态</div><div class="line">#/etc/init.d/iptable stop                   ## 本次关闭防火墙</div><div class="line">#/etc/init.d/iptable restart                ## 重启防火墙</div></pre></td></tr></table></figure>
<h4 id="5-永久性关闭防火墙"><a href="#5-永久性关闭防火墙" class="headerlink" title="5. 永久性关闭防火墙"></a>5. 永久性关闭防火墙</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#chkconfig --level 35 iptables off          ## 注意中间的是两个英式小短线；重启</div></pre></td></tr></table></figure>
<h4 id="6-CentOS的iptables示例"><a href="#6-CentOS的iptables示例" class="headerlink" title="6. CentOS的iptables示例"></a>6. CentOS的iptables示例</h4><pre><code># Firewall configuration written by system-config-securitylevel
# Manual customization of this file is not recommended.*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:RH-Firewall-1-INPUT - [0:0]
-A INPUT -j RH-Firewall-1-INPUT
-A FORWARD -j RH-Firewall-1-INPUT
-A RH-Firewall-1-INPUT -i lo -j ACCEPT
-A RH-Firewall-1-INPUT -p icmp –icmp-type any -j ACCEPT
-A RH-Firewall-1-INPUT -p 50 -j ACCEPT
-A RH-Firewall-1-INPUT -p 51 -j ACCEPT
-A RH-Firewall-1-INPUT -m state –state ESTABLISHED,RELATED -j ACCEPT
-A RH-Firewall-1-INPUT -m state –state NEW -m tcp -p tcp –dport 53 -j ACCEPT
-A RH-Firewall-1-INPUT -m state –state NEW -m udp -p udp –dport 53 -j ACCEPT
-A RH-Firewall-1-INPUT -m state –state NEW -m tcp -p tcp –dport 22 -j ACCEPT
-A RH-Firewall-1-INPUT -m state –state NEW -m tcp -p tcp –dport 25 -j ACCEPT
-A RH-Firewall-1-INPUT -m state –state NEW -m tcp -p tcp –dport 80 -j ACCEPT
-A RH-Firewall-1-INPUT -m state –state NEW -m tcp -p tcp –dport 443 -j ACCEPT
-A RH-Firewall-1-INPUT -j REJECT –reject-with icmp-host-prohibited
COMMIT
</code></pre><p>要根据具体需求修改此文件，如不希望开放80端口提供web服务，那么应相应地删除80所在一行即可。全部修改完后重启iptables，之后使用命令<code>iptables -L</code>可验证一下是否规则都已经生效，至此完成防火墙设置修改。</p>
<hr>
<h3 id="HAProxy关闭"><a href="#HAProxy关闭" class="headerlink" title="HAProxy关闭"></a>HAProxy关闭</h3><p>直接kill pid即可。</p>
<hr>
<h3 id="HAProxy脚本启动和关闭"><a href="#HAProxy脚本启动和关闭" class="headerlink" title="HAProxy脚本启动和关闭"></a>HAProxy脚本启动和关闭</h3><h4 id="1-编写启动脚本"><a href="#1-编写启动脚本" class="headerlink" title="1. 编写启动脚本"></a>1. 编写启动脚本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi /etc/rc.d/init.d/haproxy</div></pre></td></tr></table></figure>
<p>本身不存在此文件，使用以上命令，进入vi编辑器，再使用命令保存退出即可。<br>打开文件haproxy，贴入如下内容：</p>
<pre><code>#!/bin/bash
BASE_DIR=&quot;/usr/local/haproxy&quot;
ARGV=&quot;$@&quot;  

start()
{
echo &quot;START HAPoxy SERVERS&quot;
$BASE_DIR/sbin/haproxy -f $BASE_DIR/haproxy.cfg
}

stop()
{
echo &quot;STOP HAPoxy Listen&quot;
kill -TTOU $(cat $BASE_DIR/logs/haproxy.pid)
echo &quot;STOP HAPoxy process&quot;
kill -USR1 $(cat $BASE_DIR/logs/haproxy.pid)
}
case $ARGV in

start)
start
ERROR=$?
;;

stop)
stop
ERROR=$?
;;

restart)
stop
start
ERROR=$?
;;

*)
echo &quot;hactl.sh [start|restart|stop]&quot;
esac
exit $ERROR
</code></pre><h4 id="2-脚本随系统自启动"><a href="#2-脚本随系统自启动" class="headerlink" title="2. 脚本随系统自启动"></a>2. 脚本随系统自启动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">chmod +x /etc/rc.d/init.d/haproxy</div><div class="line">chkconfig --add haproxy</div><div class="line">chkconfig  haproxy on</div></pre></td></tr></table></figure>
<p>如果出现结果： <em>service haproxy does not support chkconfig</em><br>解决办法是在 <strong>/etc/rc.d/init.d/haproxy</strong> 中添加下面两句到 <strong>#!/bin/bash</strong> 之后:</p>
<pre><code>#chkconfig: 2345 10 90
#description:haproxy
</code></pre><p>—-其中2345是默认启动级别，级别有0-6共7个级别。<br>—-等级0表示：表示关机<br>—-等级1表示：单用户模式<br>—-等级2表示：无网络连接的多用户命令行模式<br>—-等级3表示：有网络连接的多用户命令行模式<br>—-等级4表示：不可用<br>—-等级5表示：带图形界面的多用户模式<br>—-等级6表示：重新启动<br>—-10是启动优先级，90是停机优先级，优先级范围是0-100，数字越大，优先级越低。</p>
<blockquote>
<p>添加后效果如下：<br>    [root@Linux-xx ~]# cat /etc/rc.d/init.d/haproxy</p>
<pre><code>#!/bin/bash
#chkconfig: 2345 10 90
#description:haproxy
BASE_DIR=&quot;/usr/local/haproxy&quot;
ARGV=&quot;$@&quot;  
start()
...
...
</code></pre></blockquote>
<h4 id="3-启动与关闭"><a href="#3-启动与关闭" class="headerlink" title="3. 启动与关闭"></a>3. 启动与关闭</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">service haproxy start</div><div class="line">service haproxy stop</div></pre></td></tr></table></figure>
        </div>

        <!-- YPN Add 2016-11-14 增加打赏 start -->
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center">
          <div></div>
          <button id="rewardButton", disable="enable", onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}", style="cursor: pointer; border: 0; outline: 0; border-radius: 100%; padding: 0; margin: 0; letter-spacing: normal; text-transform: none; text-indent: 0px; text-shadow: none">
            <span onmouseover="this.style.color='rgb(236,96,0)';this.style.background='rgb(204,204,204)'" onmouseout="this.style.color='#fff';this.style.background='rgb(236,96,0)'" style="display: inline-block; width: 70px; height: 70px; border-radius: 100%; line-height: 81px; color: #fff; font: 400 35px/75px 'microsofty'; background: rgb(236,96,0)">赏</span>
          </button>
          <div id="QR" style="display: none;">
            
              <div id="wechat" style="display: inline-block">
                <img id="wechat_qr" src="/assets/blogImg/YPN_wechatpay-32x32.png" alt="昜丿捺 WeChat Pay" style="width: 200px; max-width: 100%; display: inline-block"/>
                <p>微信打赏</p>
              </div>
            
          
            <div id="alipay" style="display: inline-block">
              <img id="alipay_qr" src="/assets/blogImg/YPN_alipay-32x32.jpg" alt="昜丿捺 Alipay" style="width: 200px; max-width: 100%; display: inline-block"/>
              <p>支付宝打赏</p>
            </div>
          
          </div>
        </div>
        <!-- YPN Add 2016-11-14 增加打赏 end -->

        <!-- 多说最近访客 start -->
        <div class="ds-recent-visitors" data-num-items="28" data-avatar-size="42" id="ds-recent-visitors"></div>
        <!-- 多说最近访客 end -->

        <!-- 多说评论框 start -->
        <div class="ds-thread" data-thread-key="2017/12/19/【HAProxy】安装配置/" data-title="【HAProxy】安装配置" data-url="http://yoursite.com/2017/12/19/【HAProxy】安装配置/"></div>
        <!-- 多说评论框 end -->

        <!-- YPN ADD 2017-11-02 新增 Hitokoto·一言经典语句-->
        <script type="text/javascript" src="https://api.lwl12.com/hitokoto/main/get?encode=js&charset=utf-8"></script>
        <div id="lwlhitokoto"><script>lwlhitokoto()</script></div>

      </div>
    </div>
  </div>
</article>



    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <p class="copyright text-muted">
          Theme By <a target="_blank" href="https://github.com/levblanc">Levblanc.</a>
          Inspired By <a target="_blank" href="https://github.com/klugjo/hexo-theme-clean-blog">Clean Blog.</a>
        <p class="copyright text-muted">
          Powered By <a target="_blank" href="https://hexo.io/">Hexo.</a>
        <p class="copyright text-muted">
          本站总访问量 <span id="busuanzi_value_site_pv"></span> 次, 访客数 <span id="busuanzi_value_site_uv"></span> 人次, 本文总阅读量 <span id="busuanzi_value_page_pv"></span> 次
        </p>
      </div>
    </div>
  </div>
</footer>

<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
  
  _st('install','Bw13BEeK5ASKzfM4WzMC','2.0.0');
</script>

<!--2017-10-06 YPN Add 添加鼠标点击特效 -->
<script type="text/javascript">
  /* 鼠标点击特效 */
  var a_idx = 0;
  jQuery(document).ready(function($) {
      $("body").click(function(e) {
  var a = new Array("富强", "民主", "文明", "和谐", "自由", "平等", "公正" ,"法治", "爱国", "敬业", "诚信", "友善");
  var $i = $("<span/>").text(a[a_idx]);
          a_idx = (a_idx + 1) % a.length;
  var x = e.pageX,
          y = e.pageY;
          $i.css({
  "z-index": 999999999999999999999999999999999999999999999999999999999999999999999,
  "top": y - 20,
  "left": x,
  "cursor":"default",
  "position": "absolute",
  "font-weight": "bold",
  "color": "#ff6651"
          });
          $("body").append($i);
          $i.animate({
  "top": y - 180,
  "opacity": 0
          },
          1500,
  function() {
              $i.remove();
          });
      });
  });
</script>

<!--2017-10-06 YPN Add 添加输入框特效。 -->
<script src="/js/activate-power-mode.js"></script>
<script>
  POWERMODE.colorful = true; // 控制开启/开启礼花特效  
  POWERMODE.shake = true;    // 控制开启/关闭屏幕震动特效  
  document.body.addEventListener('input', POWERMODE);
</script>

    <!-- After Footer Scripts -->
<script src="/js/highlight.pack.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    var codeBlocks = Array.prototype.slice.call(document.getElementsByTagName('pre'))
    codeBlocks.forEach(function(block, index) {
      hljs.highlightBlock(block);
    });
  });
</script>

<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"yangpiena"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '/js/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->

<div id="totop" style="position:fixed;bottom:50px;right:30px;cursor: pointer;">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
</div>
<script src="/js/totop.js"></script>

<script type="text/javascript" src="https://cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script>
  </body>
</html>

