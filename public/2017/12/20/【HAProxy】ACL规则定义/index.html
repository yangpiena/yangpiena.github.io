<!DOCTYPE HTML>
<html class="no-js" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
    <!--[if lte IE 9]>
<meta http-equiv="refresh" content="0;url=http://yoursite.com/warn.html">
<![endif]-->
<meta charset="utf-8">
<meta http-equiv="X-DNS-Prefetch-Control" content="on">
<link rel="dns-prefetch" href="http://yoursite.com">
<link rel="dns-prefetch" href="//www.google-analytics.com">
<link rel="prefetch" href="http://yoursite.com">
<link rel="prefetch" href="//www.google-analytics.com">


<link rel="prerender" href="http://yoursite.com">

<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no">
<meta http-equiv="mobile-agent" content="format=html5; url=http://yoursite.com">
<meta name="author" content="昜丿捺">
<link rel="stylesheet" href="/css/JSimple.css">

<link rel="shortcut icon" href="/images/favicon.png">


<title>【haproxy】acl规则定义 - 昜丿捺</title>

<meta name="keywords" content="undefined">

<meta name="description " content="没有阳光，沉默而居">

    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                processEscapes: true
            }
        });
    </script>


    

    

</head>
<body>
<div id="nav">
    <nav class="nav-menu">
        <a class="site-name current" href="/" title="说">说</a>
        <a class="site-index current" href="/"><i class="fa fa-home"></i><span>Home</span></a>
        <a href="/archives" title="Archives"><i class="fa fa-archives"></i><span>Archives</span></a>
        <a href="/tags" title="Tags"><i class="fa fa-tags"></i><span>Tags</span></a>
        <!-- custom single page of menus -->
        
        
        <a href="/help" title="帮助">
            <i class="fa fa-question-circle"></i>
            <span>帮助</span>
        </a>
        
    </nav>
</div>

<div class="nav-user">
    <a class="btn-search" href="#"><i class="fa fa-search"></i></a>
    <a class="btn-read-mode" href="#"><i class="fa fa-sun-o"></i></a>
    <a class="btn-sns-qr" href="javascript:"><i class="fa fa-telegram"></i></a>
</div>

<div id="wrapper" class="clearfix">
    <div id="body">
        <div class="main" id="main">
            <div id="cover">
    <div class="cover-img"></div>
    <div class="cover-info">
        
        <h1 class="cover-siteName">说IT</h1>
        <h3 class="cover-siteTitle">用代码摇滚这个世界</h3>
        <p class="cover-siteDesc">一个关注技术与人文的IT博客</p>
        <div class="cover-sns">
            
    &nbsp;&nbsp;<div class="btn btn-telegram">
        <a href="http://t.me/kunyintang" target="_blank" title="telegram" ref="friend">
            <i class="fa fa-telegram"></i>
        </a>
    </div>

    &nbsp;&nbsp;<div class="btn btn-instagram">
        <a href="https://www.instagram.com/mtangsir/" target="_blank" title="instagram" ref="friend">
            <i class="fa fa-instagram"></i>
        </a>
    </div>

    &nbsp;&nbsp;<div class="btn btn-twitter">
        <a href="https://twitter.com/tangkunyin" target="_blank" title="twitter" ref="friend">
            <i class="fa fa-twitter"></i>
        </a>
    </div>

    &nbsp;&nbsp;<div class="btn btn-github">
        <a href="https://github.com/tangkunyin" target="_blank" title="github" ref="friend">
            <i class="fa fa-github"></i>
        </a>
    </div>


        </div>
    </div>
</div>

            <div class="page-title">
    <ul>
        <li><a href="/">Recent Posts</a></li>
        
            
                <li class="">
                    <a href="/categories/tech-notes" data-name="技术">技术</a>
                </li>
            
                <li class="">
                    <a href="/categories/humanities" data-name="人文">人文</a>
                </li>
            
                <li class="">
                    <a href="/categories/others" data-name="其他">其他</a>
                </li>
            
        
        <li class="page-search">
    <form id="search" class="search-form">
        <input type="text" readonly="readonly" id="local-search-input-tip" placeholder="click to search...">
        <button type="button" disabled="disabled" class="search-form-submit"><i class="fa fa-search"></i></button>
    </form>
</li>

    </ul>
</div>
<div class="main-inner">
    <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
        <div class="post-header">
            <div class="post-author clearfix">
                <a class="avatar fleft" href="https://shuoit.net" target="_blank">
                    <img width="48" src="/images/favicon.png" alt="avatar">
                </a>
                <p><span class="label">Author</span>
                    <a href="https://shuoit.net" target="_blank">纠结伦</a>
                    <span title="Last edited at&nbsp;2017-12-20">2017-12-20</span>
                </p>
                <p>一个搬🧱的劳斯基😁️️</p>
            </div>
            <h2 class="post-title">【HAProxy】ACL规则定义</h2>
            <div class="post-meta">
                emm... 4812 words in the article |
                you are the&nbsp;<span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span>th friend who reading now
            </div>
        </div>
        <div class="post-content markdown-body">
            <p>HAProxy的ACL具有很强大的功能，能够定义三到七层的规则。ACL的作用，就是为了匹配一些特别的请求，然后对其进行修改或者分发到不同的服务器组中。<br>HAProxy的ACL用于实现基于请求报文的首部、响应报文的内容或 其它的环境状态信息来做出转发决策，这大大增强了其配置弹性。 其配置法则通常分为两步，首先去定义ACL，即定义一个测试条件 ，而后在条件得到满足时执行某特定的动作，如阻止请求或转发至 某特定的后端。</p>
<a id="more"></a>
<hr>
<h3 id="ACL规则定义"><a href="#ACL规则定义" class="headerlink" title="ACL规则定义"></a>ACL规则定义</h3><p>格式：<code>acl &lt;aclname&gt; &lt;criterion&gt; [flags] [operator] [&lt;value&gt;]</code></p>
<p><code>&lt;aclname&gt;</code>：ACL名称，区分字符大小写，且其只能包含大小写字母、数字、-(连接线)、_(下划线)、.(点号)和:(冒号)；haproxy中，acl可以重名，这可以把多个测试条件定义为一个共同的acl；<br><code>&lt;criterion&gt;</code>：测试标准，即对什么信息发起测试；测试方式可以由[flags]指定的标志进行调整；而有些测试标准也可以需要为其在<code>&lt;value&gt;</code>之前指定一个操作符[operator]；<br><code>[flags]</code>：目前haproxy的acl支持的标志位有3个：</p>
<ul>
<li>-i：不区分中模式字符的大小写；</li>
<li>-f：从指定的文件中加载模式；</li>
<li>–：标志符的强制结束标记，在模式中的字符串像标记符时使用；</li>
</ul>
<p><code>&lt;value&gt;</code>：acl测试条件支持的值有以下4类：</p>
<ul>
<li>整数或整数范围：如1024:65535表示从1024至65535；仅支持使用正整数(如果出现类似小数的标识，其为通常为版本测试)，且支持使用的操作符有5个，分别为eq、ge、gt、le和lt；</li>
<li>字符串：支持使用“-i”以忽略字符大小写，支持使用“\”进行转义；如果在模式首部出现了-i，可以在其之前使用“–”标志位；</li>
<li>正则表达式：其机制类同字符串匹配；</li>
<li>IP地址及网络地址；<blockquote>
<p>注意:同一个acl中可以指定多个测试条件，这些测试条件需要由逻辑操作符指定其关系。条件间的组合测试关系有三种：“与”(默认即为与操作)、“或”(使用“||”操作符)以及“非”(使用“!”操作符)。</p>
</blockquote>
</li>
</ul>
<hr>
<h6 id="常用的测试标准-criteria"><a href="#常用的测试标准-criteria" class="headerlink" title="常用的测试标准(criteria)"></a>常用的测试标准(criteria)</h6><ul>
<li><strong>基于七层协议（http）规则acl测试标准</strong></li>
</ul>
<ol>
<li><p>method <code>&lt;string&gt;</code><br>测试HTTP请求报文中请求类型。<br>例如： 利用method来实现前段读写分离：</p>
<pre><code>acl  read method GET
acl  read method HEAD
acl write method PUT
acl write method POST
use_backend imgservers if read
use_backend uploadservers if write
</code></pre></li>
<li><p>path_beg <code>&lt;string&gt;</code> ||url_beg<br>用于测试请求的URL是否以指定的模式开头;下面的例子用于测试URL是否以 /static、/images、/javascript或/stylesheets头。<br>例如：利用path_beg实现以/static /images开头的请求转交到 static server上：</p>
<pre><code>acl url_static path_beg -i /static /images 
use_backend static if url_static 
</code></pre></li>
<li><p>path_end <code>&lt;string&gt;</code> || url_reg<br>用于测试请求的URL是否以<string>指定的模式结尾。例如，下面的例子用户测试URL是否以jpg、gif、png、css或js结尾<br>例如：利用path_end实现以.jpg .gif .png .css等结尾的格式的请求转交到 static server上：</string></p>
<pre><code>acl url_static path_end -i .jpg .gif .png .css .js .html
use_backend static if url_static
</code></pre></li>
<li><p>hdr_beg <code>&lt;string&gt;</code><br>用于测试请求报文的指定首部的开头部分是否符合<string>指定的模式。<br>例如：当request header中的host前缀部分匹配到lvs.test.net.:8080则将请求转给后端backend定义的 is_lvs3上</string></p>
<pre><code>acl is_lvs3 hdr_beg(host) -i lvs3.test.net:8080  
use_backend lvs3 if is_lvs3 
</code></pre></li>
<li><p>hdr_end <code>&lt;string&gt;</code><br>用于测试请求报文的指定首部的结尾部分是否符合<string>指定的模式<br>例如：当request header中的host后缀部分匹配到lvs3.test.net.:8080则将请求转给后端backend定义的 is_lvs2上</string></p>
<pre><code>acl is_lvs3 hdr_end(host) -i lvs3.test.net:8080  
use_backend lvs3 if is_lvs2 
</code></pre></li>
<li><p>hdr <code>&lt;string&gt;</code><br>用于测试请求报文中的所有首部或指定首部信息是否满足指定的条件；指定首部时， 其名称不区分大小写， 且在括号中“（）”不能有任何多余的空白字符。测试服务器端的响应报文时可以使用shdr()。<br>例如 当用户访问172.16.1.100时，重定向到<a href="http://www.afwing.com" target="_blank" rel="noopener">http://www.afwing.com</a></p>
<pre><code>acl  dstipaddr  hdr(Host) 172.16.1.100
redirect  location   http://www.afwing.com if  dstipaddr
</code></pre></li>
<li><p>hdr_reg <code>&lt;string&gt;</code><br>如果请求的域名满足正则表达式，返回true， -i是忽略大小写</p>
<pre><code>acl denali_policy hdr_reg(host) -i ^(www.inbank.com|image.inbank.com)$
</code></pre></li>
<li><p>hdr_dom <code>&lt;string&gt;</code><br>如果请求域名满足www.inbank.com，返回true， -i是忽略大小写</p>
<pre><code>acl tm_policy hdr_dom(host) -i www.inbank.com
</code></pre></li>
<li><p>url_sub<br>在请求url中包含sip_apiname=，则此控制策略返回true，否则为false</p>
<pre><code>acl invalid_req url_sub -i sip_apiname=#定义一个名为invalid_req的策略
</code></pre></li>
<li><p>url_dir<br>在请求url中存在timetask作为部分地址路径，则此控制策略返回true，否则返回false</p>
<pre><code>acl timetask_req url_dir -i timetask
</code></pre></li>
<li><p>hdr_cnt <code>&lt;string&gt;</code><br>当请求的header中Content-length等于0时，返回true</p>
<pre><code>acl missing_cl hdr_cnt(Content-length) eq 0
</code></pre></li>
</ol>
<ul>
<li><strong>基于四层协议（ip）规则acl测试标准</strong></li>
</ul>
<ol>
<li><p>dst和dst_port<br>定义访问地址为目标地址或目标端口的acl规则</p>
</li>
<li><p>src和src_port<br>定义访问地址为源地址或源端口的acl规则<br>例如： 允许10.0.0.0/24的用户访问，其他用户将禁止</p>
<pre><code>acl net10  src  10.0.0.0/24
tcp-request content  accept  if  net10
tcp-request  content  reject
tcp-request content accept [ {if | unless} ]
Accept a connection if/unless a content inspection condition is matched
</code></pre></li>
</ol>
<hr>
<h3 id="ACL规则引用"><a href="#ACL规则引用" class="headerlink" title="ACL规则引用"></a>ACL规则引用</h3><p>当定义好了ACL后我们可以利用“use_backend” 参数来引用acl规则，如果需要引用多个acl时，只需要依次在后面添加相关acl ，也可以 匹配多个acl，如下示例：</p>
<ol>
<li><p>正常写法：</p>
<pre><code>use_backend static if url_static
</code></pre></li>
<li><p>或者写法：</p>
<pre><code>use_backend backend1 if aclA || aclB 
use_backend backend1 if aclA || !aclC
</code></pre><p>注意上面“||”也可以使用or来表示</p>
</li>
<li><p>非（不符合）写法：</p>
<pre><code>use_backend backend1 if aclA !aclB 
use_backend backend1 if aclA !aclB !aclC
</code></pre></li>
<li><p>与（and）写法：</p>
<pre><code>use_backend backend1 if aclA !aclB 
use_backend backend1 if aclA !aclB !aclC
</code></pre></li>
</ol>
<hr>
<h6 id="常见应用实例"><a href="#常见应用实例" class="headerlink" title="常见应用实例"></a>常见应用实例</h6><ol>
<li><p>当请求中header中Content-length等于0，阻止请求返回403</p>
<pre><code>block if missing_cl
</code></pre></li>
<li><p>block表示阻止请求，返回403错误，当前表示如果不满足策略invalid_req，或者满足策略timetask_req，则阻止请求。</p>
<pre><code>block if !invalid_req || timetask_req
</code></pre></li>
<li><p>当满足denali_policy的策略时，使用denali_server的backend</p>
<pre><code>use_backend denali_server if denali_policy
</code></pre></li>
<li><p>当满足tm_policy的策略时，使用tm_server的backend</p>
<pre><code>use_backend tm_server if tm_policy
</code></pre></li>
<li><p>reqisetbe关键字定义，根据定义的关键字选择backend</p>
<pre><code>reqisetbe ^Host:\ img dynamic
reqisetbe ^[^\ ]\*\ /(img|css)/ dynamic
reqisetbe ^[^\ ]\*\ /admin/stats stats
</code></pre></li>
<li><p>以上都不满足的时候使用默认mms_server的backend</p>
<pre><code>default_backend mms
</code></pre></li>
<li><p>利用acl实现页面动静分离;</p>
<pre><code>frontend webservs
         bind            *:80
         acl             url_static path_beg -i /static /images /javascript /stylesheets
         acl             url_static path_end -i .jpg .gif .png .css .js .html
         acl             url_php    path_end  -i .php
         use_backend     static if url_static or host_static
         use_backend     dynamic if url_php
         default_backend dynamic
backend static
        balance roundrobin
        server  node1 192.168.1.111:80 check maxconn 3000
backend dynamic
        balance roundrobin
        server  node2 192.168.1.112:80 check maxconn 1000  
</code></pre></li>
</ol>

        </div>
        <div class="post-tool">
            <a class="btn-thumbs-up" href="javascript:void(0);" data-cid="52" title="95">
                <i class="fa fa-thumbs-up" aria-hidden="true"></i> Donate
            </a>
        </div>
        
        <div class="post-tags">Tags：
            
            <a href="/tags/HAProxy/">HAProxy</a>
            
        </div>
        
    </article>
    
    <p style="text-align: center">This article just represents my own viewpoint. If there is something wrong, please correct me.</p>
    
    

    

</div>
<script src="/js/busuanzi.pure.mini.js"></script>


        </div><!-- end #main-->
    </div><!-- end #body -->
    <footer class="footer">
    <div class="footer-inner" style="text-align: center">
        <p>
            <a href="/about" title="About">About</a>&nbsp;&nbsp<em>·</em>&nbsp;&nbsp
            <!-- 自定义链接 -->
            <a href="/help" title="Help">Help</a>&nbsp;&nbsp<em>·</em>&nbsp;&nbsp
            <a href="/links" title="Links">Links</a>&nbsp;&nbsp<em>·</em>&nbsp;&nbsp
            <a href="/sitemap.xml" title="SiteMap">SiteMap</a>
        </p>
        <p>
            Has been established&nbsp<a href="/timeline" id="siteBuildingTime"></a>&nbspDays，<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="licence">Based on Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0)</a><br>
            ©2017-<span id="cpYear"></span> Based on&nbsp<a href="http://hexo.io" target="_blank" rel="nofollow">Hexo</a>
            ，Theme by&nbsp&nbsp<a href="https://github.com/tangkunyin/hexo-theme-jsimple" target="_blank" rel="bookmark">JSimple</a>
            ，Author&nbsp<a href="https://shuoit.net" target="_blank" rel="friend">纠结伦</a>
            ，Hosted by <a href="https://pages.github.com/" target="_blank" rel="nofollow">GitHub Pages</a>
        </p>
    </div>
</footer>
<script src="/js/SimpleCore.js"></script>

</div>
<!-- search pop -->
<div class="popup search-popup local-search-popup">
    <div class="local-search-header clearfix">
        <span class="search-icon">
            <i class="fa fa-search"></i>
        </span>
        <span class="popup-btn-close">
            <i class="fa fa-times-circle"></i>
        </span>
        <div class="local-search-input-wrapper">
            <input id="local-search-input" spellcheck="false" type="text" autocomplete="off" placeholder="Input query keywords here...">
        </div>
    </div>
    <div id="local-search-result"></div>
</div>
<div class="fixed-btn">
    <a class="btn-gotop" href="javascript:"> <i class="fa fa-angle-up"></i></a>
</div>
<script>
    $(function () {
        var jsi_config = {
            buildingTime: '01/20/2018',
            current: $('.post-tags').length > 0 ? 'post' : 'archive',
            snsQRCode: '/images/sns-qrcode.png',
            donateImg: '/images/donate-qr.png',
            localSearch: { dbPath: '' },
            readMode: 'day'
        };
        
        SimpleCore.init(jsi_config);
        
    });
</script>
</body>
</html>
